<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlindMate - AI Assistant for Visually Impaired</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
    <div class="container-fluid h-100">
        <header class="row bg-primary text-white py-3">
            <div class="col-12 text-center">
                <h1 class="display-4 mb-0">
                    <i class="fas fa-eye" aria-hidden="true"></i>
                    BlindMate
                </h1>
                <p class="lead mb-0">Your AI-Powered Navigation Assistant</p>
            </div>
        </header>

        <main class="row flex-grow-1">
            <!-- Video Feed Section -->
            <div class="col-lg-8 col-12 p-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-camera" aria-hidden="true"></i>
                            Live Detection Feed
                        </h3>
                        <span id="detectionStatus" class="badge bg-secondary">Inactive</span>
                    </div>
                    <div class="card-body position-relative p-0">
                        <video id="webcam" autoplay muted playsinline class="w-100 h-100" style="object-fit: cover;"></video>
                        <canvas id="canvas"></canvas>
                        
                        <!-- Navigation Map Overlay -->
                        <div id="navigationMapContainer" class="position-absolute top-0 start-0 w-100 h-100" style="display: none; z-index: 10;">
                            <div id="map" class="w-100 h-100"></div>
                            <div class="position-absolute top-0 end-0 p-2">
                                <button id="closeMap" class="btn btn-dark btn-sm">
                                    <i class="fas fa-times"></i> Close Map
                                </button>
                                <button id="showMap" class="btn btn-success btn-sm ms-1">
                                    <i class="fas fa-map"></i> Show Map
                                </button>
                            </div>
                        </div>
                        
                        <!-- Detection indicator -->
                        <div id="detectionIndicator" class="detection-indicator" style="display: none;">
                            <i class="fas fa-eye"></i> Detecting Objects
                        </div>
                        
                        <!-- Loading overlay -->
                        <div id="loadingOverlay" class="position-absolute top-50 start-50 translate-middle text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="h5">Initializing AI Detection...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="col-lg-4 col-12 p-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                            Control Panel
                        </h3>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <!-- Tutorial Access -->
                        <div class="mb-3">
                            <button id="tutorialButton" class="btn btn-info w-100 mb-2" onclick="launchTutorial()">
                                <i class="fas fa-graduation-cap" aria-hidden="true"></i>
                                Start Tutorial
                            </button>
                            <small class="text-muted">New to BlindMate? Start with our guided tutorial</small>
                        </div>

                        <!-- Status Display -->
                        <div class="mb-4">
                            <h5>System Status</h5>
                            <div id="systemStatus" class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                Waiting to initialize...
                            </div>
                            
                            <!-- Action Status -->
                            <div id="status" class="alert alert-secondary mt-2" role="alert" style="display: none;">
                                <i class="fas fa-cog fa-spin" aria-hidden="true"></i>
                                <span id="statusText">Ready</span>
                            </div>
                            
                            <!-- Error Messages -->
                            <div id="error-message" class="alert alert-danger mt-2" role="alert" style="display: none;">
                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                <span id="errorText">Error message</span>
                            </div>
                        </div>

                        <!-- Language Selection -->
                        <div class="mb-4">
                            <label for="languageSelect" class="form-label h5">
                                <i class="fas fa-language" aria-hidden="true"></i>
                                Language
                            </label>
                            <select id="languageSelect" class="form-select form-select-lg">
                                <option value="en-IN">English (India)</option>
                                <option value="hi-IN">हिंदी (Hindi)</option>
                                <option value="ta-IN">தமிழ் (Tamil)</option>
                                <option value="te-IN">తెలుగు (Telugu)</option>
                                <option value="bn-IN">বাংলা (Bengali)</option>
                                <option value="mr-IN">मराठी (Marathi)</option>
                                <option value="gu-IN">ગુજરાતી (Gujarati)</option>
                            </select>
                        </div>

                        <!-- Control Buttons -->
                        <div class="d-grid gap-3 flex-grow-1">
                            <button id="startDetectionBtn" class="btn btn-success btn-lg">
                                <i class="fas fa-play" aria-hidden="true"></i>
                                Start Detection
                            </button>
                            
                            <button id="stopDetectionBtn" class="btn btn-danger btn-lg" disabled>
                                <i class="fas fa-stop" aria-hidden="true"></i>
                                Stop Detection
                            </button>
                            
                            <button id="voiceCommandBtn" class="btn btn-primary btn-lg">
                                <i class="fas fa-microphone" aria-hidden="true"></i>
                                Voice Command
                            </button>
                            
                            <!-- Universal Navigation Button -->
                            <button id="mainButton" class="btn btn-primary btn-lg main-nav-button">
                                <i class="fas fa-microphone" aria-hidden="true"></i>
                                Start Listening
                            </button>
                            
                            <small class="text-muted text-center mt-1 mb-2">
                                <strong>Universal Navigation:</strong><br>
                                Say "Go to [any place]" - works with any Google Maps location<br>
                                <em>Examples: "Take me to India Gate", "Go to Central Park", "Navigate to Times Square"</em>
                            </small>
                            
                            <button id="locationBtn" class="btn btn-warning btn-lg">
                                <i class="fas fa-location-dot" aria-hidden="true"></i>
                                Enable Location
                            </button>
                            

                        </div>

                        <!-- Status Indicators -->
                        <div class="mt-4">
                            <div class="row text-center">
                                <div class="col-4">
                                    <span class="badge bg-secondary" id="detectionStatus">Inactive</span>
                                    <br><small class="text-muted">Detection</small>
                                </div>
                                <div class="col-4">
                                    <span class="badge bg-secondary" id="voiceStatus">Ready</span>
                                    <br><small class="text-muted">Voice</small>
                                </div>
                                <div class="col-4">
                                    <span class="badge bg-secondary" id="navigationStatus">Ready</span>
                                    <br><small class="text-muted">Navigation</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation Instructions -->
                        <div class="mt-3">
                            <h6 class="mb-2">Navigation Guide:</h6>
                            <div class="card border-success">
                                <div class="card-body p-2">
                                    <p class="mb-2 text-success"><i class="fas fa-info-circle"></i> <strong>Works with ANY location!</strong></p>
                                    <ul class="mb-2 small">
                                        <li>"Take me to India Gate"</li>
                                        <li>"Go to Connaught Place" </li>
                                        <li>"Navigate to Central Park"</li>
                                        <li>"Directions to Times Square"</li>
                                    </ul>
                                    <p class="mb-0 small text-muted">BlindMate will confirm destination and provide step-by-step walking directions with live GPS tracking and automatic rerouting.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Display Area -->
                        <div class="mt-3">
                            <div class="card border-info">
                                <div class="card-body p-3">
                                    <div id="statusText" class="h6 mb-1">Ready to Navigate</div>
                                    <div id="instructionText" class="small text-muted">Press the button or say "Hey BlindMate, go to [destination]"</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation Controls (initially hidden) -->
                        <div id="navigationControls" style="display: none;" class="mt-2">
                            <button id="showMapBtn" class="btn btn-info w-100 mb-2">
                                <i class="fas fa-map" aria-hidden="true"></i>
                                Show Navigation Map
                            </button>
                            <button id="emergencyStop" class="btn btn-danger w-100">
                                <i class="fas fa-stop" aria-hidden="true"></i>
                                Emergency Stop Navigation
                            </button>
                        </div>
                        
                        <!-- Debug Controls (for troubleshooting) -->
                        <div class="mt-2">
                            <button id="testVoiceBtn" class="btn btn-secondary btn-sm w-100" onclick="if(window.navigation) window.navigation.testVoiceRecognition()">
                                <i class="fas fa-microphone-slash" aria-hidden="true"></i>
                                Test Voice Recognition
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="row bg-dark text-white py-3">
            <div class="col-12 text-center">
                <p class="mb-0">
                    <i class="fas fa-heart text-danger" aria-hidden="true"></i>
                    Empowering Independence Through Technology
                </p>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Google Maps JavaScript API - loaded dynamically with real key -->
    <script>
        // Google Maps will be used for navigation and map display
        console.log('Google Maps JavaScript API will be used for navigation');
        
        // Initialize Google Maps
        function initMap() {
            console.log('Google Maps API loaded successfully');
            window.googleMapsLoaded = true;
            
            // Initialize the navigation map
            if (window.navigation) {
                window.navigation.initializeMap();
            }
        }
        
        // Load Google Maps API with real key from backend
        async function loadGoogleMapsAPI() {
            try {
                const response = await fetch('/api/google-maps-key');
                const data = await response.json();
                
                if (data.key) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&callback=initMap&libraries=places`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                    console.log('Loading Google Maps API with valid key');
                } else {
                    console.error('Google Maps API key not available');
                }
            } catch (error) {
                console.error('Failed to load Google Maps API key:', error);
            }
        }
        
        // Load the API when page loads
        document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
    </script>
    
    <!-- Main Application Script -->
    <script src="app.js"></script>
    
    <!-- Enhanced Navigation System -->
    <script src="navigation.js"></script>
    
    <!-- Universal Navigation Integration -->
    <script>
        // Initialize Universal Navigation System
        let navigation;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Universal Navigation System
            navigation = new UniversalNavigation();
            
            // Make navigation globally accessible
            window.navigation = navigation;
            
            console.log('BlindMate Navigation System initialized');
        });
        
        // Tutorial launch function
        function launchTutorial() {
            if (window.blindMate) {
                window.blindMate.speak('Starting BlindMate tutorial. This will help you learn all the features.');
            }
            setTimeout(() => {
                window.location.href = '/tutorial';
            }, 2000);
        }
    </script>
</body>
</html>
